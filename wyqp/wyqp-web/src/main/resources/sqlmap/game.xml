<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.worldwalker.game.wyqp.common.dao.GameDao">
	
	
	<resultMap id="gameModelResultMap" type="gameModel" >
		<result column="proxy_id" property="proxyId"/>
		<result column="player_id" property="playerId"/>
		<result column="nick_name" property="nickName"/>
		<result column="mobile_phone" property="mobilePhone"/>
		<result column="wechat_num" property="wechatNum"/>
		<result column="real_name" property="realName"/>
		<result column="before_withdrawal_amount" property="beforeWithdrawalAmount"/>
		<result column="withdrawal_amount" property="withdrawalAmount"/>
		<result column="extract_amount" property="extractAmount"/>
		<result column="remainder_amount" property="remainderAmount"/>
		<result column="total_income" property="totalIncome"/>
		<result column="password" property="password"/>
		<result column="wx_pay_price" property="wxPayPrice"/>
		<result column="create_time" property="createTime"/>
		<result column="room_card_num" property="roomCardNum"/>
		<result column="win_probability" property="winProbability"/>
		<result column="club_id" property="clubId"/>
		<result column="status" property="status"/>
		<result column="type" property="type"/>
		<result column="club_name" property="clubName"/>
		<result column="club_owner_word" property="clubOwnerWord"/>
		<result column="is_admin" property="isAdmin"/>
		<result column="head_img_url" property="headImgUrl"/>
		
		<result column="table_num" property="tableNum"/>
		<result column="game_type" property="gameType"/>
		<result column="detail_type" property="detailType"/>
		<result column="pay_type" property="payType"/>
		<result column="remark" property="remark"/>
		<result column="total_games" property="totalGames"/>
	</resultMap>
	
	
	<insert id="insertProxy" parameterType="gameQuery">  
	     <selectKey keyProperty="proxyId" resultType="Integer">  
	         select LAST_INSERT_ID()  
	     </selectKey>  
	     insert into t_proxy( 
		     					player_id, 
		     					mobile_phone, 
		     					password,
		     					wechat_num,
		     					create_time,
		     					update_time
	     					) 
	     			values(  
		     					#{playerId}, 
		     					#{mobilePhone},
		     					#{password},
		     					#{wechatNum},
		     					now(),
		     					now()
		     				)    
    </insert>
    
    <insert id="insertProxyClub" parameterType="gameQuery">  
	     <selectKey keyProperty="clubId" resultType="Integer">  
	         select LAST_INSERT_ID()  
	     </selectKey>  
	     insert into t_proxy_club( 
	     						club_name,
	     						club_owner_word,
		     					proxy_id, 
		     					player_id,
		     					wechat_num,
		     					nick_name,
		     					head_img_url,
		     					type,
		     					status,
		     					create_time,
		     					update_time
	     					) 
	     			values(  
	     						#{clubName},
	     						#{clubOwnerWord},
		     					#{proxyId},
		     					#{playerId},
		     					#{wechatNum},
		     					#{nickName},
		     					#{headImgUrl},
		     					#{type},
		     					#{status},
		     					now(),
		     					now()
		     				)    
    </insert>
    
    <insert id="insertClubUser" parameterType="gameQuery">  
	     <selectKey keyProperty="id" resultType="Long">  
	         select LAST_INSERT_ID()  
	     </selectKey>  
	     insert into t_club_user( 
	     						proxy_id,
		     					club_id, 
		     					player_id,
		     					nick_name,
		     					head_img_url,
		     					status,
		     					create_time,
		     					update_time
	     					) 
	     			values(  
	     						#{proxyId},
		     					#{clubId},
		     					#{playerId},
		     					#{nickName},
		     					#{headImgUrl},
		     					#{status},
		     					now(),
		     					now()
		     				)    
    </insert>
    
    <insert id="insertClubTable" parameterType="gameQuery">  
	     <selectKey keyProperty="id" resultType="Long">  
	         select LAST_INSERT_ID()  
	     </selectKey>  
	     insert into t_club_table( 
		     					club_id, 
		     					table_num,
		     					game_type,
		     					detail_type,
		     					pay_type,
		     					total_games,
		     					remark,
		     					create_time
	     					) 
	     			values(  
		     					#{clubId},
		     					#{tableNum},
		     					#{gameType},
		     					#{detailType},
		     					#{payType},
		     					#{totalGames},
		     					#{remark},
		     					now()
		     				)    
    </insert>
    
    <update id="updateProxy"  parameterType="gameQuery">
		 UPDATE t_proxy
		 <trim prefix="set" suffixOverrides=",">
		  <if test="mobilePhone!=null">mobile_phone=#{mobilePhone},</if>
		  <if test="wechatNum!=null">wechat_num=#{wechatNum},</if>
		  <if test="playerId!=null">player_id=#{playerId},</if>
		  <if test="newPassword!=null">password=#{newPassword},</if>
		 </trim>
		 WHERE proxy_id=#{proxyId}
	</update>
    
	<select id="getProxyInfo"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select total_income, extract_amount, remainder_amount
	    from t_proxy
	    where proxy_id = #{proxyId}
	</select>
	
	<select id="getTotalIncome"  parameterType = "gameQuery" resultType="Long">
	    select proxy_id, player_id, nick_name , mobile_phone, wechat_num
	    from t_proxy
	    where proxy_id = #{proxyId}
	</select>
	
	<select id="getMyMembers"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select a.player_id, a.nick_name,b.proxy_id, a.create_time
	    from t_proxy_user a left join t_proxy b on a.proxy_id = b.proxy_id
	    where  1=1
	    <if test="proxyId !=null ">  
	       and a.proxy_id = #{proxyId}
	    </if>
	     and <![CDATA[ a.create_time >= #{startDate} and a.create_time <= #{endDate} ]]>
	    order by create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getMyMembersCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_proxy_user a left join t_proxy b on a.proxy_id = b.proxy_id
	    where  1=1
	    <if test="proxyId !=null ">  
	       and a.proxy_id = #{proxyId}
	    </if>
	     and <![CDATA[ a.create_time >= #{startDate} and a.create_time <= #{endDate} ]]>
	</select>
	
	<select id="getBillingDetails"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	   select a.player_id, a.nick_name, b.wx_pay_price, b.create_time
	    from t_proxy_user a
	    left join t_order b
	    on a.player_id = b.player_id
	    where 1=1
	    <if test="proxyId !=null ">  
	       and a.proxy_id = #{proxyId}
	    </if>
	    and b.pay_status = 1 and <![CDATA[ b.create_time >= #{startDate} and b.create_time <= #{endDate} ]]>
	    order by create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getBillingDetailsCount"  parameterType = "gameQuery" resultType="Long">
	   select count(1)
	    from t_proxy_user a
	    left join t_order b
	    on a.player_id = b.player_id
	    where  1=1
	    <if test="proxyId !=null ">  
	       and a.proxy_id = #{proxyId}
	    </if>
	     and b.pay_status = 1 and <![CDATA[ b.create_time >= #{startDate} and b.create_time <= #{endDate} ]]>
	</select>
	
	<select id="getWithDrawalRecords"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select before_withdrawal_amount, withdrawal_amount, create_time
	    from t_proxy_withdrawal_log
	    where  1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	     and <![CDATA[ create_time >= #{startDate} and create_time <= #{endDate} ]]>
	    order by create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getWithDrawalRecordsCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_proxy_withdrawal_log
	    where   1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	     and <![CDATA[ create_time >= #{startDate} and create_time <= #{endDate} ]]>
	</select>
	
	<select id="getProxyByPhoneAndPassword"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select proxy_id,player_id,nick_name,mobile_phone,wechat_num,real_name,is_admin
	    from t_proxy
	    where mobile_phone = #{mobilePhone} and password = #{password}
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	</select>
	
	
	<select id="getUserByCondition"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select player_id,nick_name, room_card_num,win_probability
	    from t_user
	    where 1=1
	    <if test="playerId !=null ">  
	        and player_id = #{playerId} 
	    </if>  
	    <if test="proxyId !=null ">  
	        and proxy_id = #{proxyId} 
	    </if>
	    <if test="nickName !=null and nickName !='' ">  
	        and nick_name like CONCAT('%',#{nickName},'%') 
	    </if>
   	 	limit #{offset}, #{limit}
	</select>
	
	<select id="getUserByConditionCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_user
	    where 1=1
	    <if test="playerId !=null ">  
	        and player_id = #{playerId} 
	    </if>  
	    <if test="proxyId !=null ">  
	        and proxy_id = #{proxyId} 
	    </if>
	    <if test="nickName !=null and nickName !='' ">  
	        and nick_name like CONCAT('%',#{nickName},'%') 
	    </if>
	</select>
	
	<update id="updateRoomCardNumByPlayerId"  parameterType = "gameQuery">
	    update t_user
	    set room_card_num = room_card_num + #{changeRoomCardNum}
	    where player_id = #{playerId} and room_card_num = #{roomCardNum}
	</update>
	
	<update id="updateProbabilityByPlayerId"  parameterType = "gameQuery">
	    update t_user
	    set win_probability =  #{winProbability}
	    where player_id = #{playerId}
	</update>
	
	<select id="getProxys"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select proxy_id, real_name,wechat_num,mobile_phone,player_id,nick_name,create_time
	    from t_proxy
	    where  1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	     and <![CDATA[ create_time >= #{startDate} and create_time <= #{endDate} ]]>
	    order by create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getProxysCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_proxy
	    where  1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	     and <![CDATA[ create_time >= #{startDate} and create_time <= #{endDate} ]]>
	</select>
	
	
	<select id="getProxyClubs"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select club_id,club_name,club_owner_word, proxy_id,player_id,wechat_num,nick_name,status,room_card_num,create_time
	    from t_proxy_club
	    where  1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	    <if test="playerId !=null ">  
	       and player_id = #{playerId}
	    </if>
	    <if test="clubId !=null ">  
	       and club_id = #{clubId}
	    </if>
	    <if test="status !=null ">  
	       and status = #{status}
	    </if>
	    order by create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getProxyClubsCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_proxy_club
	    where  1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	    <if test="playerId !=null ">  
	       and player_id = #{playerId}
	    </if>
	    <if test="clubId !=null ">  
	       and club_id = #{clubId}
	    </if>
	    <if test="status !=null ">  
	       and status = #{status}
	    </if>
	</select>
	<update id="updateProxyClub"  parameterType = "gameQuery">
	    update t_proxy_club
	    set 
	    update_time = #{status}
	    <if test="status !=null ">  
	       , status = #{status}
	    </if>
	    <if test="clubName !=null ">  
	       , club_name = #{clubName}
	    </if>
	    <if test="clubOwnerWord !=null ">  
	       , club_owner_word = #{clubOwnerWord}
	    </if>
	    where 
	    club_id = #{clubId} 
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if> 
	    <if test="playerId !=null ">  
	       and player_id = #{playerId}
	    </if> 
	</update>
	
	<delete id="delProxyClub"  parameterType = "gameQuery">
	    delete from  t_proxy_club
	    where club_id = #{clubId}
	</delete>
	
	<select id="getClubUsers"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select a.proxy_id,a.club_id,a.player_id,a.nick_name,a.status,a.create_time,a.head_img_url
	    from t_club_user a
	    where  1=1
	    <if test="proxyId !=null ">  
	       and a.proxy_id = #{proxyId}
	    </if>
	    <if test="playerId !=null ">  
	       and a.player_id = #{playerId}
	    </if>
	    <if test="clubId !=null ">  
	       and a.club_id = #{clubId}
	    </if>
	    <if test="status !=null ">  
	       and a.status = #{status}
	    </if>
	    order by a.create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getClubUsersCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_club_user
	    where  1=1
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	    <if test="playerId !=null ">  
	       and player_id = #{playerId}
	    </if>
	    <if test="clubId !=null ">  
	       and club_id = #{clubId}
	    </if>
	    <if test="status !=null ">  
	       and status = #{status}
	    </if>
	</select>
	<update id="updateClubUser"  parameterType = "gameQuery">
	    update t_club_user
	    set status = #{status}
	    where club_id = #{clubId} and player_id = #{playerId}
	</update>
	
	<delete id="delClubUser"  parameterType = "gameQuery">
	    delete from  t_club_user
	    where club_id = #{clubId} 
	    <if test="playerId !=null ">  
	       and player_id = #{playerId}
	    </if>
	</delete>
	
	
	
	<select id="getRoomInfos"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select a.proxy_id,a.club_id,a.player_id,a.nick_name,a.status,a.create_time,b.head_img_url
	    from t_club_user a left join t_user b on a.player_id = b.player_id
	    where  1=1
	    <if test="roomId !=null ">  
	       and room_id = #{roomId}
	    </if>
	    <if test="clubId !=null ">  
	       and club_id = #{clubId}
	    </if>
	    order by a.create_time desc
	    limit #{offset}, #{limit}
	</select>
	<select id="getRoomInfoCount"  parameterType = "gameQuery" resultType="Long">
	    select count(1)
	    from t_user_record_detail
	    where  1=1
	    <if test="roomId !=null ">  
	       and room_id = #{roomId}
	    </if>
	    <if test="clubId !=null ">  
	       and club_id = #{clubId}
	    </if>
	</select>
	
	
	<select id="getJoinedClubs"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select a.club_id,b.club_name,b.nick_name,b.player_id
	    from t_club_user a 
	    left join t_proxy_club b on a.club_id = b.club_id
	    where  1=1 
	    <if test="proxyId !=null ">  
	       and a.proxy_id = #{proxyId}
	    </if>
	    <if test="playerId !=null ">  
	       and a.player_id = #{playerId}
	    </if>
	    <if test="clubId !=null ">  
	       and a.club_id = #{clubId}
	    </if>
	    <if test="status !=null ">  
	       and a.status = #{status}
	    </if>
	    order by a.create_time desc
	    limit 100
	</select>
	
	<select id="getCreatedClubs"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select club_id,club_name,nick_name,player_id
	    from t_proxy_club 
	    where  1=1 
	    <if test="proxyId !=null ">  
	       and proxy_id = #{proxyId}
	    </if>
	    <if test="playerId !=null ">  
	       and player_id = #{playerId}
	    </if>
	    <if test="clubId !=null ">  
	       and club_id = #{clubId}
	    </if>
	    <if test="status !=null ">  
	       and status = #{status}
	    </if>
	    order by create_time desc
	    limit 100
	</select>
	
	<select id="getClubTables"  parameterType = "gameQuery" resultMap="gameModelResultMap">
	    select club_id,table_num,game_type,detail_type,pay_type,total_games,remark
	    from t_club_table 
	    where  club_id = #{clubId}
	    <if test="tableNum !=null ">  
	       and table_num = #{tableNum}
	    </if>
	</select>
	
	<select id="getMaxClubTableNum"  parameterType = "gameQuery" resultType="Integer">
	    select max(table_num)
	    from t_club_table 
	    where  club_id = #{clubId}
	</select>
	<delete id="delClubTable"  parameterType = "gameQuery">
	    delete from  t_club_table
	    where club_id = #{clubId} 
	    <if test="tableNum != null ">  
	       and table_num = #{tableNum}
	    </if> 
	</delete>
	
	<update id="updateClubTable"  parameterType = "gameQuery">
	    update t_club_table
	    set 
	    <if test="gameType !=null ">  
	       and game_type = #{gameType}
	    </if>
	    <if test="detailType !=null ">  
	       and detail_type = #{detailType}
	    </if>
	    <if test="payType !=null ">  
	       and pay_type = #{payType}
	    </if>
	    <if test="totalGames !=null ">  
	       and total_games = #{totalGames}
	    </if>
	    <if test="remark !=null ">  
	       and remark = #{remark}
	    </if>
	    where 
	    club_id = #{clubId} 
        and table_num = #{tableNum}
	</update>
</mapper>


